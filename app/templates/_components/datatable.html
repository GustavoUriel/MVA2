{% macro datatable(id, columns, api_endpoint, page_length=25, editable=false, color_rules=None, labels=None) -%}
<div class="datatable-container">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="{{ id }}_labels_btn">Manage Labels</button>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="{{ id }}_color_rules_btn">Color Rules</button>
    </div>
    <div class="text-muted small">Table: {{ id }}</div>
  </div>

  <table id="{{ id }}" class="table table-striped table-hover" style="width:100%">
    <thead>
      <tr>
        {%- for col in columns %}
        <th data-col="{{ col.data }}">{{ col.title }}</th>
        {%- endfor %}
        <th>Actions</th>
      </tr>
    </thead>
  </table>
</div>

<!-- Labels Manager Modal -->
<div class="modal fade" id="{{ id }}_labels_modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Manage Labels</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Add label</label>
          <div class="input-group">
            <input id="{{ id }}_new_label_name" class="form-control form-control-sm" placeholder="Label name">
            <input id="{{ id }}_new_label_color" type="color" class="form-control form-control-sm" value="#ffcc00" style="width:56px;padding:2px;">
            <button id="{{ id }}_add_label" class="btn btn-sm btn-primary">Add</button>
          </div>
        </div>
        <div id="{{ id }}_labels_list" class="mt-3"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Color Rules Manager Modal -->
<div class="modal fade" id="{{ id }}_color_rules_modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Color Rules</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3 row g-2 align-items-center">
          <div class="col-md-4">
            <select id="{{ id }}_rule_col" class="form-select form-select-sm">
              <option value="">Select column</option>
              {% for col in columns %}
              <option value="{{ col.data }}">{{ col.title }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <select id="{{ id }}_rule_op" class="form-select form-select-sm">
              <option value="eq">equals</option>
              <option value="neq">not equals</option>
              <option value="gt">&gt;</option>
              <option value="lt">&lt;</option>
              <option value="contains">contains</option>
            </select>
          </div>
          <div class="col-md-3">
            <input id="{{ id }}_rule_value" class="form-control form-control-sm" placeholder="Value">
          </div>
          <div class="col-md-2 d-flex gap-2">
            <input id="{{ id }}_rule_color" type="color" class="form-control form-control-sm" value="#ffdddd" style="width:56px;padding:2px;">
            <button id="{{ id }}_add_rule" class="btn btn-sm btn-primary">Add</button>
          </div>
        </div>

        <div id="{{ id }}_rules_list" class="mt-2"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  if (!document.getElementById('{{ id }}')) return;

  // Build initial column defs from provided columns
  const providedCols = [
    {% for col in columns %}{ data: '{{ col.data }}', title: '{{ col.title }}', editable: {{ 'true' if col.get('editable', False) else 'false' }} },{% endfor %}
  ];

  // Ensure a hidden id column exists for resource updates
  // Keep columns consistent with the rendered table header. We'll rely on
  // resource IDs being present in row data (id / patient_id / taxonomy_id)
  // so we do NOT inject a hidden `id` column here â€” that would desynchronize
  // the JS `cols` array with the DOM <thead> and cause DataTables to read
  // missing header cells (leading to "reading 'style' of undefined" errors).
  let cols = providedCols.slice();

  // Append actions column
  cols.push({ data: null, orderable: false, searchable: false, defaultContent: '' });

  // table will be initialized below once via the shared initializer
  var table = null;

  // Column filters will be created after the table is initialized so `table` is defined

  // Inline edit handler
  {% if editable %}
  $(`#{{ id }} tbody`).on('dblclick', 'td', function(){
    const cell = table.cell(this);
    const colIdx = cell.index().column;
    const colDef = table.settings().init().columns[colIdx] || {};
    const field = colDef.data;
    if (!field || field === null) return;
    const rowData = table.row(cell.index().row).data();
    const original = cell.data();
    const input = $('<input type="text" class="form-control form-control-sm">').val(original);
    $(this).html(input);
    input.focus();
    function finish(save){
      const val = input.val();
      if (save && val !== original){
        const id = rowData.id || rowData.patient_id || rowData.taxonomy_id;
        if (id){
          const endpoint = '{{ api_endpoint }}' + '/' + id;
          const payload = {};
          payload[field] = val;
          fetch(endpoint, { method: 'PUT', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
            .then(r => { if (!r.ok) throw new Error('save failed'); return r.json(); })
            .then(data => { cell.data(data[field] !== undefined ? data[field] : val).draw(false); })
            .catch(err => { console.error(err); cell.data(original).draw(false); });
        } else {
          cell.data(val).draw(false);
        }
      } else { cell.data(original).draw(false); }
    }
    input.on('blur', function(){ finish(true); });
    input.on('keydown', function(ev){ if (ev.key === 'Enter') finish(true); if (ev.key === 'Escape') finish(false); });
  });
  {% endif %}

  // Initialize via shared initializer and pass any stored runtime options
  (function(){
    var runtimeOpts = (window._datatable_init_opts && window._datatable_init_opts['{{ id }}']) || {};
    var initOptions = Object.assign({}, runtimeOpts, { inlineEdit: {{ 'true' if editable else 'false' }}, pageLength: {{ page_length }} });
    // call shared initializer if available
    if (window.MVA2 && MVA2.datatable && typeof MVA2.datatable.init === 'function'){
      table = MVA2.datatable.init('#{{ id }}', cols, '{{ api_endpoint }}', initOptions);

      // Now create per-column filter inputs and attach them to the DataTable
      const $thead = $(`#{{ id }} thead`);
      const $clone = $thead.find('tr').clone(true);
      const columnFilterFns = [];
      $clone.find('th').each(function(i){
        const txt = $(this).text().trim();
        $(this).html('<input class="form-control form-control-sm" placeholder="Filter '+txt+'"/>');
        const $inp = $(this).find('input');
        $inp.on('keyup change clear', function(){
          if (table && table.column && table.column(i).search() !== this.value){ table.column(i).search(this.value).draw(); }
        });
        // add a function that will extract this input's value for server-side requests
        columnFilterFns.push((function(colIndex, $input){
          return function(){
            const v = $input.val();
            const colDef = cols[colIndex] || {};
            const colName = colDef.data || ('col_' + colIndex);
            const key = 'filter_' + colName;
            const obj = {};
            if (v && v.length) obj[key] = v;
            return obj;
          };
        })(i, $inp));
      });
      $thead.append($clone);

      // attach columnFilterFns to options so datatable.init will include them in ajax payload
      if (!window._datatable_init_opts) window._datatable_init_opts = {};
      window._datatable_init_opts['{{ id }}'] = { columnFilterInputs: columnFilterFns };
    }
  })();

});
</script>

{%- endmacro %}
